<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Kareem (Ar)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Cairo&family=El+Messiri&family=Harmattan&family=Lateef&family=Scheherazade+New&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main/css/surah.css">
    <style>
        /* ... (Your existing CSS styles) ... */
    </style>
</head>
<body>

<div class="settings-container">
    </div>

<div class="header">
    </div>

<div id="first-verse" class="first-verse" style="display: none;"></div>
<div id="content"></div>

<button class="back-to-top" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
</button>

<div id="image-preview">
    <img id="preview-image" src="" alt="Verse Image">
    <div id="image-editor">
        <div id="editable-verse-text" class="editable-text" contenteditable="true"></div>
        <input type="color" id="text-color" class="color-picker" value="#000000">
    </div>
    <button onclick="downloadImage()">Download Image</button>
    <button onclick="closePreview()">Close</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const darkMode = localStorage.getItem('darkMode') === 'true';
        const textSize = localStorage.getItem('textSize') || '18';
        if (darkMode) {
            document.body.classList.add('dark-mode');
        }

        document.body.style.fontSize = textSize + 'px';

        const index = getQueryParam('index');
        fetchSurah(index ? index : 1);
        displayHistory(); 
    });

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    async function fetchSurah(index) {
        const arabicResponse = await fetch(`https://raw.githubusercontent.com/itzfew/Quran-Online/refs/heads/main/source/surah/surah_${String(index).padStart(1, '0')}.json`);
        const arabicData = await arabicResponse.json();

        const translationResponse = await fetch(`https://raw.githubusercontent.com/itzfew/Quran-Online/refs/heads/main/source/translation/en/en_translation_${String(index).padStart(1, '0')}.json`);
        const translationData = await translationResponse.json();

        const urduResponse = await fetch(`https://raw.githubusercontent.com/itzfew/Quran-Online/refs/heads/main/source/translation/ur/t_surah_${String(index).padStart(3, '0')}.json`);
        const urduData = await urduResponse.json();

        displaySurah(arabicData, translationData, urduData);
    }

    function displaySurah(arabicData, translationData, urduData) {
        // ... (Your existing code to display surah content) ...

        for (let i = 1; i <= count; i++) {
            // ... (Your existing code to create verseDiv) ...

            const downloadButton = document.createElement('button');
            downloadButton.classList.add('download-btn');
            downloadButton.innerText = 'Download Image';
            verseDiv.appendChild(downloadButton);

            generateVerseImage(arabicVerse, i); // Generate image for each verse

            // ... (rest of your existing code) ...
        }
    }

    const backgroundImageUrls = [
        "https://i.ytimg.com/vi/vsGDkyfbOCw/hq720.jpg?sqp=-oaymwEXCK4FEIIDSFryq4qpAwkIARUAAIhCGAE=&rs=AOn4CLBzhBZq3_36lbUX6JQh0hDILX3nDg",
        "https://t4.ftcdn.net/jpg/03/21/06/95/360_F_321069500_jgiE640YA8DHtZjwMRftcTtnYNo7sHwR.jpg"
    ];

    function generateVerseImage(verseText, verseNumber) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const backgroundImage = new Image();
        backgroundImage.crossOrigin = "anonymous";
        backgroundImage.src = backgroundImageUrls[Math.floor(Math.random() * backgroundImageUrls.length)];

        backgroundImage.onload = () => {
            canvas.width = backgroundImage.width;
            canvas.height = backgroundImage.height;
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            ctx.font = '30px Amiri';
            ctx.fillStyle = document.getElementById('text-color').value;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const words = verseText.split(' ');
            let lines = [];
            let currentLine = '';
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine ? currentLine + ' ' + words[i] : words[i];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > canvas.width * 0.8) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);

            const lineHeight = 40;
            let y = canvas.height / 2 - (lines.length * lineHeight) / 2;

            for (const line of lines) {
                ctx.fillText(line, canvas.width / 2, y);
                y += lineHeight;
            }

            const dataURL = canvas.toDataURL('image/png');
            const verseElement = document.getElementById(`verse-${verseNumber}`);
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('verse-image-container');
            const verseImage = document.createElement('img');
            verseImage.src = dataURL;
            verseImage.classList.add('verse-image');
            imageContainer.appendChild(verseImage);

            verseElement.insertBefore(imageContainer, verseElement.firstChild);

            const downloadButton = verseElement.querySelector('.download-btn');
            downloadButton.onclick = () => showPreview(dataURL, verseText, verseNumber);
        }
    }

    function showPreview(imageUrl, verseText, verseNumber) {
        document.getElementById('preview-image').src = imageUrl;
        document.getElementById('editable-verse-text').innerText = verseText;
        document.getElementById('editable-verse-text').dataset.verseNumber = verseNumber;
        document.getElementById('image-preview').style.display = 'block';

        const textColor = getComputedStyle(document.getElementById(`verse-${verseNumber}`).querySelector('.arabic-text')).color;
        document.getElementById('text-color').value = rgbToHex(textColor);
    }

    function rgbToHex(rgb) {
        let [r, g, b] = rgb.match(/\d+/g);
        r = parseInt(r).toString(16); g = parseInt(g).toString(16); b = parseInt(b).toString(16);
        r = r.length == 1 ? "0" + r : r; g = g.length == 1 ? "0" + g : g; b = b.length == 1 ? "0" + b : b;
        return "#" + r + g + b;
    }

    function closePreview() {
        document.getElementById('image-preview').style.display = 'none';
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.href = document.getElementById('preview-image').src;
        link.download = 'verse.png';
        link.click();
    }

document.getElementById('text-color').addEventListener('change', function() {
        const newColor = this.value;
        const verseNumber = document.getElementById('editable-verse-text').dataset.verseNumber;
        const previewImage = document.getElementById('preview-image');

        // 1. Re-create the canvas and draw with the new color:
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = previewImage.src; // Use current preview image as source

        img.onload = () => {
             canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0); // Redraw existing image

            ctx.font = '30px Amiri'; // Or your font
            ctx.fillStyle = newColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const verseText = document.getElementById('editable-verse-text').innerText;
            const words = verseText.split(' ');
            let lines = [];
            let currentLine = '';
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine ? currentLine + ' ' + words[i] : words[i];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > canvas.width * 0.8) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);

            const lineHeight = 40; // Adjust as needed
            let y = canvas.height / 2 - (lines.length * lineHeight) / 2;

            for (const line of lines) {
                ctx.fillText(line, canvas.width / 2, y);
                y += lineHeight;
            }

            const newDataURL = canvas.toDataURL('image/png');
            previewImage.src = newDataURL; // Update the preview image

        }
    });


    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark);
    }

    function changeTextSize(increment) {
        const newSize = parseInt(document.body.style.fontSize) + increment;
        document.body.style.fontSize = newSize + 'px';
        localStorage.setItem('textSize', newSize);
    }

    let currentSurahIndex = 1;

    function navigateSurah(direction) {
        currentSurahIndex += direction;

        if (currentSurahIndex < 1) {
            currentSurahIndex = 1;
        } else if (currentSurahIndex > 114) {
            currentSurahIndex = 114;
        }

        const newUrl = `https://quran-online.pages.dev/surah?index=${currentSurahIndex}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
        window.location.reload();
    }

    function shareVerse(verseId) {
        const verseText = document.getElementById(`verse-${verseId}`).innerText;
        if (navigator.share) {
            navigator.share({
                title: 'Quran Verse',
                text: verseText,
                url: window.location.href
            }).catch((error) => console.log('Error sharing: ', error));
        } else {
            navigator.clipboard.writeText(verseText).then(() => {
                alert('Verse copied to clipboard!');
            }).catch((error) => {
                console.log('Error copying to clipboard: ', error);
            });
        }
    }

    function viewVerse(verseId) {
        const surahIndex = getQueryParam('index') || 1;
        window.location.href = `verse.html?surah=${surahIndex}&verse=${verseId}`;
    }

    function navigateToWordToWord() {
        const surahIndex = getQueryParam('index') || currentSurahIndex;
        if (surahIndex) {
            window.location.href = `wordtoword.html?index=${surahIndex}#1`;
        } else {
            console.error("Unable to determine Surah index.");
        }
    }

    function navigateToRead() {
        const surahIndex = getQueryParam('index') || currentSurahIndex;
        const surahNumber = surahIndex.split('/')[0];
        const pageNumber = 1;
        window.location.href = `read?index=${surahNumber}/${pageNumber}`;
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleHighlight(verseId) {
        const allVerses = document.querySelectorAll('.verse');
        allVerses.forEach(verse => {
            verse.classList.remove('selected');
            const shareButton = verse.querySelector('.share-btn');
            const viewButton = verse.querySelector('.view-btn');
            const downloadButton = verse.querySelector('.download-btn');
            if (shareButton) shareButton.style.display = 'none';
            if (viewButton) viewButton.style.display = 'none';
            if (downloadButton) downloadButton.style.display = 'none';
        });

        const verseElement = document.getElementById(`verse-${verseId}`);
        verseElement.classList.add('selected');
        const shareButton = verseElement.querySelector('.share-btn');
        const viewButton = verseElement.querySelector('.view-btn');
        const downloadButton = verseElement.querySelector('.download-btn');
        if (shareButton) shareButton.style.display = 'inline-block';
        if (viewButton) viewButton.style.display = 'inline-block';
        if (downloadButton) downloadButton.style.display = 'inline-block';
    }

    function displayHistory() {
        // (If you have any history display logic, put it here)
    }

</script>

</body>
</html>
