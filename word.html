<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --highlight-color: #ffe0b3;
            --text-color: #333;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --urdu-color: #e74c3c;
            --translation-color: #27ae60;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Amiri Quran', serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 20px;
        }

        #app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 10px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #surah-name {
            font-size: 1.5rem;
            margin: 0;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            background-color: white;
            position: sticky;
            top: 68px;
            z-index: 99;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-button {
            font-size: 1rem;
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-button:hover {
            opacity: 0.9;
        }

        #current-surah {
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }

        #quran {
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ayah {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            position: relative;
            transition: all 0.3s ease;
        }

        .ayah.highlight {
            background-color: var(--highlight-color);
            border-color: #ffb84d;
            animation: pulse 2s ease-out;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 184, 77, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 184, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 184, 77, 0); }
        }

        .ayah-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ayah-number {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 50%;
            font-size: 0.8rem;
        }

        #bookmarked-verses {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
            white-space: nowrap;
        }

        #bookmark-list {
            display: inline-flex;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        #bookmark-list li {
            margin-right: 10px;
            background-color: var(--light-bg);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        #bookmark-list li:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .word {
            display: inline-block;
            margin: 5px;
            text-align: center;
            vertical-align: top;
        }

        .word span {
            display: block;
            margin: 3px 0;
        }

        .word .arabic {
            font-size: 1.4rem;
            line-height: 1.8;
        }

        .word .translation {
            font-size: 0.7rem;
            color: var(--translation-color);
            border-top: 1px dashed var(--border-color);
            padding-top: 3px;
        }

        .word .urdu {
            font-size: 0.8rem;
            color: var(--urdu-color);
            border-top: 1px dashed var(--border-color);
            padding-top: 3px;
        }

        .ayah-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 5px;
        }

        .ayah-buttons button {
            font-size: 0.8rem;
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-grow: 1;
            justify-content: center;
        }

        .ayah-buttons button:hover {
            opacity: 0.9;
        }

        .full-translation {
            background-color: var(--light-bg);
            padding: 10px;
            margin-top: 10px;
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            color: var(--text-color);
            border-radius: 5px;
            direction: ltr;
            border-left: 3px solid var(--secondary-color);
        }

        .full-translation::before {
            content: "Translation: ";
            font-weight: bold;
            color: var(--secondary-color);
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .word .arabic {
                font-size: 1.2rem;
            }
            
            .ayah-buttons button {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            #surah-name {
                font-size: 1.2rem;
            }
            
            .nav-button {
                padding: 6px 10px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .word {
                margin: 3px;
            }
            
            .word .arabic {
                font-size: 1rem;
            }
            
            .ayah {
                padding: 10px;
            }
            
            .ayah-buttons {
                flex-direction: column;
            }
            
            .ayah-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 id="surah-name">Quran Viewer</h1>
        </header>

        <div id="bookmarked-verses">
            <ul id="bookmark-list"></ul>
        </div>

        <div id="controls">
            <button id="previous-surah" class="nav-button">
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            <span id="current-surah">Loading...</span>
            <button id="next-surah" class="nav-button">
                Next <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div id="quran">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading Quran...
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            baseUrl: 'https://raw.githubusercontent.com/itzfew/Quran-Online/main/source/words/',
            translationBaseUrl: 'https://raw.githubusercontent.com/itzfew/Quran-Online/main/source/translation/en/',
            maxBookmarks: 10,
            defaultSurah: 1,
            cacheExpiry: 24 * 60 * 60 * 1000 // 24 hours
        };

        // Cache implementation
        const cache = {
            get: async (key) => {
                try {
                    const cachedData = localStorage.getItem(`cache_${key}`);
                    if (!cachedData) return null;
                    
                    const { data, timestamp } = JSON.parse(cachedData);
                    if (Date.now() - timestamp > config.cacheExpiry) {
                        localStorage.removeItem(`cache_${key}`);
                        return null;
                    }
                    return data;
                } catch (e) {
                    return null;
                }
            },
            set: async (key, data) => {
                try {
                    const cacheItem = {
                        data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(`cache_${key}`, JSON.stringify(cacheItem));
                } catch (e) {
                    console.error('Cache set error:', e);
                }
            }
        };

        // Data fetcher with caching
        async function fetchWithCache(url, cacheKey) {
            // Try to get from cache first
            const cachedData = await cache.get(cacheKey);
            if (cachedData) return cachedData;
            
            // Fetch fresh data
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                // Cache the data
                await cache.set(cacheKey, data);
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Main application
        class QuranViewer {
            constructor() {
                this.currentSurah = config.defaultSurah;
                this.initialAyah = null;
                this.metadata = null;
                this.words = null;
                this.englishWordTranslations = null;
                this.urduWordTranslations = null;
                
                this.initElements();
                this.initEventListeners();
                this.initFromURL();
            }
            
            initElements() {
                this.elements = {
                    surahName: document.getElementById('surah-name'),
                    currentSurah: document.getElementById('current-surah'),
                    quranContainer: document.getElementById('quran'),
                    bookmarkList: document.getElementById('bookmark-list'),
                    nextSurahBtn: document.getElementById('next-surah'),
                    prevSurahBtn: document.getElementById('previous-surah')
                };
            }
            
            initEventListeners() {
                this.elements.nextSurahBtn.addEventListener('click', () => this.loadSurah(this.currentSurah + 1));
                this.elements.prevSurahBtn.addEventListener('click', () => {
                    if (this.currentSurah > 1) this.loadSurah(this.currentSurah - 1);
                });
                
                window.addEventListener('popstate', () => this.initFromURL());
            }
            
            initFromURL() {
                const params = new URLSearchParams(window.location.search);
                const surah = parseInt(params.get('index')) || config.defaultSurah;
                const hash = window.location.hash.substring(1);
                const ayah = hash ? parseInt(hash) : null;
                
                this.currentSurah = surah;
                this.initialAyah = ayah;
                
                this.loadInitialData();
            }
            
            async loadInitialData() {
                try {
                    this.showLoading();
                    
                    // Load all required data in parallel
                    const [metadata, words, englishTranslations, urduTranslations] = await Promise.all([
                        this.fetchMetadata(),
                        this.fetchWords(),
                        this.fetchEnglishWordTranslations(),
                        this.fetchUrduWordTranslations()
                    ]);
                    
                    this.metadata = metadata;
                    this.words = words;
                    this.englishWordTranslations = englishTranslations;
                    this.urduWordTranslations = urduTranslations;
                    
                    await this.renderSurah(this.currentSurah, this.initialAyah);
                    this.renderBookmarks();
                } catch (error) {
                    this.showError("Failed to load Quran data. Please try again later.");
                    console.error(error);
                }
            }
            
            async fetchMetadata() {
                return fetchWithCache(
                    `${config.baseUrl}word.json`,
                    'quran_metadata'
                );
            }
            
            async fetchWords() {
                return fetchWithCache(
                    `${config.baseUrl}nastaliq-quranwbw.json`,
                    'quran_words'
                );
            }
            
            async fetchEnglishWordTranslations() {
                return fetchWithCache(
                    `${config.baseUrl}en-quranwbw.json`,
                    'quran_en_translations'
                );
            }
            
            async fetchUrduWordTranslations() {
                return fetchWithCache(
                    `${config.baseUrl}ur-quranwbw.json`,
                    'quran_ur_translations'
                );
            }
            
            async fetchFullTranslation(surahNumber) {
                return fetchWithCache(
                    `${config.translationBaseUrl}en_translation_${surahNumber}.json`,
                    `translation_${surahNumber}`
                );
            }
            
            showLoading() {
                this.elements.quranContainer.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading Quran...
                    </div>
                `;
            }
            
            showError(message) {
                this.elements.quranContainer.innerHTML = `
                    <div class="loading" style="color: red;">
                        ${message}
                    </div>
                `;
            }
            
            async renderSurah(surahNumber, ayahNumber = null) {
                try {
                    this.showLoading();
                    this.currentSurah = surahNumber;
                    
                    const fullTranslation = await this.fetchFullTranslation(surahNumber);
                    if (!fullTranslation) throw new Error("Translation not found");
                    
                    // Update UI
                    const surahName = fullTranslation.name || `Surah ${surahNumber}`;
                    const surahTitle = `${surahName} (Surah ${surahNumber})`;
                    
                    this.elements.surahName.textContent = surahTitle;
                    this.elements.currentSurah.textContent = surahTitle;
                    
                    // Organize verse data
                    const surahData = this.organizeSurahData(surahNumber);
                    
                    // Render verses
                    this.renderVerses(surahNumber, surahData, fullTranslation);
                    
                    // Scroll to specific ayah if requested
                    if (ayahNumber) {
                        this.scrollToAyah(surahNumber, ayahNumber);
                    }
                    
                    this.updateUrl(surahNumber, ayahNumber || 1);
                } catch (error) {
                    this.showError("Error loading surah. Please try again.");
                    console.error(error);
                }
            }
            
            organizeSurahData(surahNumber) {
                const surahData = {};
                
                for (const [wordId, meta] of Object.entries(this.metadata)) {
                    if (meta.surah === surahNumber && meta.ayah > 0) {
                        if (!surahData[meta.ayah]) surahData[meta.ayah] = [];
                        surahData[meta.ayah].push({
                            word: this.words[wordId],
                            englishTranslation: this.englishWordTranslations[wordId],
                            urduTranslation: this.urduWordTranslations[wordId]
                        });
                    }
                }
                
                return surahData;
            }
            
            renderVerses(surahNumber, surahData, fullTranslation) {
                this.elements.quranContainer.innerHTML = '';
                
                const isSurah1 = surahNumber === 1;
                const ayahCount = isSurah1 ? 7 : fullTranslation.count;
                
                for (let ayah = 1; ayah <= ayahCount; ayah++) {
                    const ayahDiv = document.createElement('div');
                    ayahDiv.className = 'ayah';
                    ayahDiv.id = `${surahNumber}#${ayah}`;
                    
                    // Verse header
                    const ayahHeader = document.createElement('div');
                    ayahHeader.className = 'ayah-header';
                    ayahHeader.innerHTML = `
                        <span>Verse ${ayah}</span>
                        <span class="ayah-number">${ayah}</span>
                    `;
                    ayahDiv.appendChild(ayahHeader);
                    
                    // Arabic words with translations
                    if (surahData[ayah]) {
                        surahData[ayah].forEach(wordData => {
                            const wordSpan = document.createElement('span');
                            wordSpan.className = 'word';
                            wordSpan.innerHTML = `
                                <span class="arabic">${wordData.word}</span>
                                <span class="translation">${wordData.englishTranslation}</span>
                                <span class="translation urdu">${wordData.urduTranslation}</span>
                            `;
                            ayahDiv.appendChild(wordSpan);
                        });
                    }
                    
                    // Full translation
                    const verseIndex = isSurah1 ? ayah - 1 : ayah;
                    const fullTranslationDiv = document.createElement('div');
                    fullTranslationDiv.className = 'full-translation';
                    fullTranslationDiv.textContent = fullTranslation.verse[`verse_${verseIndex}`] || 'Translation not available';
                    ayahDiv.appendChild(fullTranslationDiv);
                    
                    // Action buttons
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'ayah-buttons';
                    buttonsDiv.innerHTML = `
                        <button onclick="quranViewer.bookmarkAyah(${surahNumber}, ${ayah})">
                            <i class="fas fa-bookmark"></i> Bookmark
                        </button>
                        <button onclick="quranViewer.shareAyah(${surahNumber}, ${ayah})">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button onclick="quranViewer.openTafsir(${surahNumber}, ${ayah})">
                            <i class="fas fa-book-open"></i> Tafsir
                        </button>
                    `;
                    ayahDiv.appendChild(buttonsDiv);
                    
                    this.elements.quranContainer.appendChild(ayahDiv);
                }
            }
            
            scrollToAyah(surahNumber, ayahNumber) {
                const ayahElement = document.getElementById(`${surahNumber}#${ayahNumber}`);
                if (ayahElement) {
                    setTimeout(() => {
                        ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        this.highlightVerse(surahNumber, ayahNumber);
                    }, 100);
                }
            }
            
            highlightVerse(surahNumber, ayahNumber) {
                const verseElement = document.getElementById(`${surahNumber}#${ayahNumber}`);
                if (verseElement) {
                    verseElement.classList.add('highlight');
                    setTimeout(() => {
                        verseElement.classList.remove('highlight');
                    }, 3000);
                }
            }
            
            updateUrl(surahNumber, ayahNumber) {
                const newUrl = `${window.location.pathname}?index=${surahNumber}#${ayahNumber}`;
                window.history.pushState({}, '', newUrl);
            }
            
            bookmarkAyah(surahNumber, ayahNumber) {
                try {
                    const bookmarks = JSON.parse(localStorage.getItem('quran_bookmarks')) || [];
                    
                    // Check if already bookmarked
                    const existingIndex = bookmarks.findIndex(
                        b => b.surah === surahNumber && b.ayah === ayahNumber
                    );
                    
                    if (existingIndex >= 0) {
                        // Remove if already exists
                        bookmarks.splice(existingIndex, 1);
                    }
                    
                    // Add to beginning
                    bookmarks.unshift({ surah: surahNumber, ayah: ayahNumber });
                    
                    // Keep only the latest
                    if (bookmarks.length > config.maxBookmarks) {
                        bookmarks.length = config.maxBookmarks;
                    }
                    
                    localStorage.setItem('quran_bookmarks', JSON.stringify(bookmarks));
                    this.renderBookmarks();
                    
                    // Show feedback
                    const toast = document.createElement('div');
                    toast.textContent = existingIndex >= 0 ? 
                        'Bookmark removed' : 'Ayah bookmarked';
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.backgroundColor = 'var(--primary-color)';
                    toast.style.color = 'white';
                    toast.style.padding = '10px 20px';
                    toast.style.borderRadius = '5px';
                    toast.style.zIndex = '1000';
                    toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.5s';
                        setTimeout(() => toast.remove(), 500);
                    }, 2000);
                } catch (error) {
                    console.error('Bookmark error:', error);
                }
            }
            
            renderBookmarks() {
                try {
                    const bookmarks = JSON.parse(localStorage.getItem('quran_bookmarks')) || [];
                    this.elements.bookmarkList.innerHTML = '';
                    
                    bookmarks.forEach(({ surah, ayah }, index) => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `Surah ${surah}:${ayah}`;
                        listItem.title = `Go to Surah ${surah}, Ayah ${ayah}`;
                        listItem.addEventListener('click', () => {
                            this.loadSurah(surah, ayah);
                        });
                        
                        // Add remove button
                        const removeBtn = document.createElement('span');
                        removeBtn.innerHTML = ' &times;';
                        removeBtn.style.marginLeft = '5px';
                        removeBtn.style.cursor = 'pointer';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.bookmarkAyah(surah, ayah);
                        });
                        
                        listItem.appendChild(removeBtn);
                        this.elements.bookmarkList.appendChild(listItem);
                    });
                    
                    // Show empty message if no bookmarks
                    if (bookmarks.length === 0) {
                        const emptyMsg = document.createElement('li');
                        emptyMsg.textContent = 'No bookmarks yet';
                        emptyMsg.style.color = '#999';
                        emptyMsg.style.cursor = 'default';
                        this.elements.bookmarkList.appendChild(emptyMsg);
                    }
                } catch (error) {
                    console.error('Render bookmarks error:', error);
                }
            }
            
            async shareAyah(surahNumber, ayahNumber) {
                try {
                    const url = `${window.location.origin}${window.location.pathname}?index=${surahNumber}#${ayahNumber}`;
                    
                    if (navigator.share) {
                        await navigator.share({
                            title: `Surah ${surahNumber}, Ayah ${ayahNumber}`,
                            text: 'Check out this Quran verse:',
                            url: url
                        });
                    } else if (navigator.clipboard) {
                        await navigator.clipboard.writeText(url);
                        alert('Link copied to clipboard!');
                    } else {
                        // Fallback for browsers without clipboard API
                        const tempInput = document.createElement('input');
                        tempInput.value = url;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert('Link copied to clipboard!');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Share error:', error);
                    }
                }
            }
            
            openTafsir(surahNumber, ayahNumber) {
                alert(`Tafsir for Surah ${surahNumber}, Ayah ${ayahNumber} would open here.`);
                // window.open(`/tafsir?surah=${surahNumber}&ayah=${ayahNumber}`, '_blank');
            }
            
            loadSurah(surahNumber, ayahNumber = null) {
                this.renderSurah(surahNumber, ayahNumber);
            }
        }

        // Initialize the application
        const quranViewer = new QuranViewer();
        
        // Make available globally for button handlers
        window.quranViewer = quranViewer;

        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
